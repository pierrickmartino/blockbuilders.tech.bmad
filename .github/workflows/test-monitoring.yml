name: Test Monitoring

on:
  # Run on PRs that touch test checklists, PRDs, or backend tests
  pull_request:
    paths:
      - 'docs/tst-*.md'
      - 'docs/prd-*.md'
      - 'backend/tests/**'
      - 'backend/app/**'

  # Daily at 07:00 UTC
  schedule:
    - cron: '0 7 * * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  checklist-monitor:
    name: Test Checklist Monitor
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make test-runner executable
        run: chmod +x scripts/test-runner.sh

      - name: Run checklist summary
        run: scripts/test-runner.sh --detail 2>&1 | tee checklist-report.txt

      - name: Run coverage gap analysis
        run: scripts/test-runner.sh --coverage 2>&1 | tee coverage-report.txt

      - name: Generate JSON report
        run: scripts/test-runner.sh --json > checklist-report.json

      - name: Upload reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-checklist-reports
          path: |
            checklist-report.txt
            checklist-report.json
            coverage-report.txt
          retention-days: 30

      - name: Comment on PR with checklist status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('checklist-report.json', 'utf8'));

            let totalChecked = 0, totalUnchecked = 0;
            const rows = data.map(f => {
              totalChecked += f.checked;
              totalUnchecked += f.unchecked;
              const pct = f.total > 0 ? Math.round(f.checked * 100 / f.total) : 0;
              const icon = pct === 100 ? 'âœ…' : pct >= 50 ? 'ðŸŸ¡' : 'ðŸ”´';
              return `| ${icon} ${f.name} | ${f.category} | ${f.checked}/${f.total} | ${pct}% |`;
            });

            const grandTotal = totalChecked + totalUnchecked;
            const grandPct = grandTotal > 0 ? Math.round(totalChecked * 100 / grandTotal) : 0;

            const body = [
              '## ðŸ“‹ Test Checklist Status',
              '',
              `**Overall: ${totalChecked}/${grandTotal} (${grandPct}%)**`,
              '',
              '| Test File | Category | Progress | % |',
              '|-----------|----------|----------|---|',
              ...rows,
              '',
              '<details><summary>Coverage gap analysis</summary>',
              '',
              '```',
              fs.readFileSync('coverage-report.txt', 'utf8').replace(/\x1b\[[0-9;]*m/g, ''),
              '```',
              '</details>',
              '',
              '_Auto-generated by test-monitoring workflow_'
            ].join('\n');

            // Find existing comment to update instead of spamming
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Test Checklist Status')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-env

      - name: Run backend tests
        working-directory: backend
        run: pytest --tb=short -q 2>&1 | tee test-results.txt

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: backend/test-results.txt
          retention-days: 30
